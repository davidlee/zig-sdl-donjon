# T009: Targeting & Range Validation Redesign

## Problem

Current validation rejects attacks at selection time if no enemy is in range. But with a timeline system, this is wrong:

- Player is out of range
- Player plays Advance (closes distance)
- Player wants to play Attack - but can't, because validation checks *current* range

Also doesn't handle opponent moving away after you've queued an attack.

## Current State (Wrong)

- [x] Attacks have `.target = .all_enemies` - legacy from before targeting was wired up
- [x] `validateMeleeReach` checks if *any* enemy is in range at selection time
- [x] Range is treated as a card validity predicate, not a targeting constraint

## Correct Model

### Validation Categories

**Hard invalid** (reject at selection):
- Channel conflict
- Can't afford costs (stamina/focus/time)
- Wrong phase
- Card requirements (e.g., no weapon equipped)

**Soft invalid** (allow, resolve dynamically):
- No valid targets *currently* - targeting is evaluated at resolution

### Targeting vs Validity

- `Rule.valid` → card-level predicates (weapon equipped, stance requirement)
- Targeting → finds valid targets at resolution time, range included

A melee attack with no targets in range isn't invalid - it just has an empty target set *right now*.

### Attack Flow

1. Advance (target: goblin) → `.single` target, sets primary target, closes range
2. Attack (target: .single) → inherits primary target, range checked at resolution

### Primary Target & Focus Cost

- Advance/Pivot set `attention.primary` to the targeted enemy
- Subsequent attacks default to primary target (no additional selection)
- Switching to a *different* target costs focus
- Primary target resets each turn

## Changes Required

1. [x] **Update attack cards**: `.all_enemies` → `.single` (except true multi-target attacks)
2. [x] **Remove selection-time range validation**: Call site removed, cards always selectable
3. [x] **Delete dead code**: `validateMeleeReach` removed from `validation.zig`
4. [x] **Add resolution-time range check**: In `TickResolver.resolve:170-191`, checks
   `actor.weapons.getOffensiveMode(technique.attack_mode).reach` vs `engagement.range`.
   If weapon reach < engagement range → emit `attack_out_of_range` event, skip resolution.
5. [x] **Handle whiff case**: Added `attack_out_of_range` event variant in `events.zig:138-144`

## Testing

### Integration Tests (in `src/testing/integration/domain/range_validation.zig`)
- `Attack at far range emits attack_out_of_range event` - verifies out-of-range detection
- `Attack at far range does not deal damage` - confirms no damage on whiff
- `Attack at close range resolves normally` - verifies in-range hits
- `Attack with longer reach weapon hits at medium range` - tests reach boundaries
- `Attack at dagger range with sabre weapon hits` - tests longer weapon at close range

### Harness additions
- `setPlayerFromTemplate()` - configure player from persona (name, stats, resources, armament)
- `setRange()` - manipulates engagement range for test scenarios
- `getEngagement()` - inspects engagement state

## Future Work (separate task)

UI Implications:
- Cards with no *current* valid targets should show differently (not fully greyed, but indicate "no target")
- Timeline plays should show warning if target not yet valid (clears when e.g. Advance resolves)
- Expose validation failure reasons to UI (not just pass/fail)