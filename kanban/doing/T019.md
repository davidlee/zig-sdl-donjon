# T019: Test Personas & Fixtures
Created: 2026-01-08

## Problem statement / value driver

Currently 6+ duplicate `makeTestAgent` implementations across the codebase (agent.zig, positioning.zig, apply.zig, outcome.zig, damage.zig, context.zig). Tests are verbose, hard to read, and inconsistent. `apply/validation.zig` has 6 skipped tests waiting on fixtures.

### Scope - goals

- Define a small, memorable set of named personas (agents, weapons, encounters) usable by both tests and game.
- Provide fixture helpers to instantiate personas with proper allocation/teardown.
- Enable skipped tests in `apply/validation.zig` as proof of concept.

### Scope - non-goals

- Integration test harness (T020).
- Full migration of all existing test helpers (opportunistic only).
- New game content beyond what's needed for representative test coverage.

## Background

### Relevant documents

- `doc/issues/test_setup.md` - Full design doc (read it now)

### Key files

- `src/domain/combat/agent.zig` - existing `makeTestAgent`
- `src/domain/apply/validation.zig` - 6 skipped tests
- `src/domain/weapon_list.zig`, `src/domain/card_list.zig` - existing comptime data patterns

### Existing systems, memories, research, design intent

- Memories: `agents_system_overview`, `weapons_system_overview`, `body_system_overview`
- Existing weapon_list/card_list use comptime struct constants - personas should follow same pattern.

## Changes Required

### 1. Create `src/data/personas.zig`

Shared comptime data for tests AND game:

```zig
pub const Agents = struct {
    /// Naked dwarf with a rock. Minimal baseline.
    pub const grunni_the_desperate: AgentTemplate = .{ ... };

    /// Cowardly goblin archer. Ranged, low stats, flees.
    pub const snik: AgentTemplate = .{ ... };

    /// Veteran human swordsman. Competent baseline.
    pub const ser_marcus: AgentTemplate = .{ ... };

    // ~5-8 total covering: melee/ranged, armoured/unarmoured,
    // player-like/mob-like, different body plans
};

pub const Weapons = struct {
    pub const thrown_rock: weapon.Template = .{ ... };
    pub const maybe_haunted: weapon.Template = .{ ... };  // magic sword
    // ~3-4 covering different reaches, damage types, magic/mundane
};

pub const Encounters = struct {
    pub const duel_at_sword_range: EncounterTemplate = .{ ... };
    pub const goblin_ambush: EncounterTemplate = .{ ... };
    // ~3 common setups
};
```

### 2. Create `src/testing/fixtures.zig`

Instantiation helpers with clear ownership:

```zig
pub const AgentHandle = struct {
    agent: *Agent,
    // owned resources...
    pub fn deinit(self: *AgentHandle) void { ... }
};

pub fn agentFromTemplate(alloc: Allocator, template: *const AgentTemplate) !AgentHandle
pub fn worldFromEncounter(alloc: Allocator, template: *const EncounterTemplate) !WorldHandle
pub fn giveCard(world: *World, agent: *Agent, template_name: []const u8) !entity.ID
```

### 3. Enable `apply/validation.zig` tests

Migrate the 6 skipped tests to use fixtures:
- `rulePredicatesSatisfied allows card with always predicate`
- `rulePredicatesSatisfied allows shield block with shield equipped`
- `rulePredicatesSatisfied denies shield block without shield`
- `rulePredicatesSatisfied allows shield block with sword and shield dual wield`
- `validateMeleeReach passes when weapon reach >= engagement range`
- `validateMeleeReach fails when weapon reach < engagement range`
- `validateMeleeReach fails when at abstract far distance`

### Challenges / Tradeoffs / Open Questions

- **AgentTemplate vs Agent**: Need a template struct that captures enough to instantiate but isn't a full Agent. May need new type or adapt existing patterns.
- **EncounterTemplate**: Similarly needs to describe an encounter setup without being a live Encounter. Consider what fields are needed (player template, enemy templates, initial range, etc.).
- **Where to put personas**: `src/data/` is new directory. Alternative: `src/domain/personas.zig`. Preference for `data/` to signal "content, not logic".

### Decisions

(to be filled during implementation)

### Implications

- Tests become readable: `worldFromEncounter(alloc, &personas.Encounters.duel_at_sword_range)`
- Personas can appear as actual game content (tutorial enemies, etc.)
- Foundation for T020 integration harness.

## Tasks / Sequence of Work

1. [ ] Define `AgentTemplate` type (or confirm existing type suffices)
2. [ ] Define `EncounterTemplate` type
3. [ ] Create `src/data/personas.zig` with initial persona set
4. [ ] Create `src/testing/fixtures.zig` with `AgentHandle`, `WorldHandle`, instantiation helpers
5. [ ] Enable and fix `apply/validation.zig` skipped tests
6. [ ] Opportunistically migrate 1-2 other test files to validate API ergonomics
7. [ ] Update `style_conventions` memory

## Test / Verification Strategy

### success criteria / ACs

- All 6 previously-skipped validation tests pass.
- `zig build test` passes with no regressions.
- At least one other test file migrated to use fixtures.
- Personas compile and are usable from both `src/testing/` and `src/domain/`.

### unit tests

- Fixture instantiation/teardown doesn't leak (testing.allocator catches this).
- Each persona template produces a valid agent/encounter.

### integration tests

- (Deferred to T020)

### user acceptance

- Test code is noticeably more readable than inline setup.

## Quality Concerns / Risks / Potential Future Improvements

- Keep persona count small (~8 agents, ~4 weapons, ~3 encounters). Can always add more.
- Ensure templates don't duplicate weapon_list/card_list data - reference existing templates where possible.
- Future: personas could have flavor text, be used in tutorials, etc.

## Progress Log / Notes

- 2026-01-08: Task created from `doc/issues/test_setup.md`