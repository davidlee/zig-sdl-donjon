# T002: Timeline Structure

**Status**: done (100% complete)
**Phase**: 2 of 6 (Timing/Simultaneity/Positioning)
**Design Doc**: `doc/timing_simultaneity_positioning.md`
**Depends on**: T001 (Channel Foundation) - COMPLETE

## Goal

Replace flat play list with time-aware timeline; enable positioned plays and simultaneity.

## Tasks

- [x] 2.1 Create `TimeSlot` and `Timeline` types in `combat.zig`
- [x] 2.2 Migrate `TurnState` from `plays_buf` to `Timeline`
- [x] 2.3 Update `TickResolver.commitPlayerCards` to read timing from Timeline
- [x] 2.4 Update play commands to use `Timeline.nextAvailableStart()` as default
- [x] 2.5 Expose timing via `slots()` method (renamed from `plays()`)
- [x] 2.6 Write new Timeline-specific tests (see Tests Written below)

**Deferred to later**: UI timeline indication (Phase 4+ concern)

## Acceptance Criteria

- [x] Plays have explicit `time_start` stored in TurnState (duration computed on-demand)
- [x] `Timeline.canInsert()` checks both time overlap AND channel conflict
- [x] `Timeline.nextAvailableStart()` finds first gap for given channels + duration
- [x] Footwork channel can overlap weapon channel at same time (no conflict)
- [x] Existing tests pass (sequential behavior preserved via defaults)
- [x] New tests verify timeline insertion/conflict logic

## Implementation Notes (2026-01-06)

### Design Decision: Compute Duration On-Demand

**Problem**: Original spec stored `time_end` in `TimeSlot`. But modifiers can be stacked during commit phase that change `cost_mult`, making stored `time_end` stale.

**Solution**: `TimeSlot` only stores `time_start`. Duration/timeEnd computed on-demand via:
- `TimeSlot.duration(registry)` - returns `getPlayDuration(play, registry)`
- `TimeSlot.timeEnd(registry)` - returns `time_start + duration(registry)`

This ensures timing always reflects current play state including modifier effects.

### API Changes from Spec

1. **`TurnState.slots()`** instead of `plays()` - returns `[]const TimeSlot`
2. **`TurnState.addPlay(play, registry)`** - finds next available time automatically
3. **`TurnState.addPlayAt(play, time_start, registry)`** - explicit positioning
4. **`getPlayDuration`** and **`getPlayChannels`** - module-level pub functions

### Files Modified

| File | Changes |
|------|---------|
| `src/domain/combat.zig` | Added `TimeSlot`, `Timeline`; migrated `TurnState`; added helper fns |
| `src/domain/tick.zig` | `commitPlayerCards` reads `slot.time_start`, computes duration |
| `src/domain/apply.zig` | Updated all callers to use `slots()`, `addPlay(play, &registry)` |
| `src/presentation/views/combat/view.zig` | Updated to use `slots()` |

### Current Behavior

- ChannelConflict returned when playing second weapon-channel card (as expected)
- UI will need adaptation to allow timeline positioning (future work)
- Sequential play behavior preserved via `nextAvailableStart()` defaulting

## Tests Written

Added to `combat.zig` (lines 1927-2033):

```zig
test "Timeline.canInsert allows non-overlapping same channel"
test "Timeline.canInsert rejects overlapping same channel"
test "Timeline.canInsert allows overlapping different channels"
test "Timeline.nextAvailableStart finds first gap"
test "Timeline.nextAvailableStart returns null when no space"
test "Timeline.insert snaps time_start to granularity"
test "TimeSlot.overlapsWith adjacent slots do not overlap"
test "TimeSlot.overlapsWith exact same range overlaps"
```

All tests pass (134/140 total, 6 skipped unrelated).

## Unlocks

- Simultaneous footwork + weapon plays
- Foundation for manoeuvre overlays (Phase 4)
- Time-aware targeting queries (Phase 3)

---

**Created**: 2026-01-06
**T001 Completed**: 2026-01-06
**Implementation Started**: 2026-01-06
**Tests Completed**: 2026-01-06
