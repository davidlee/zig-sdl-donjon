# T021: Test Cleanup & Consolidation
Created: 2026-01-08

## Problem statement / value driver

After the apply.zig refactor into submodules (validation.zig, targeting.zig, etc.), duplicate tests remain in the parent file. Additionally, some tests are brittle - relying on exact event ordering or manual setup that breaks with minor refactors.

### Scope - goals

- Remove duplicate/redundant tests from `src/domain/apply.zig` that are now covered in submodules
- Identify and fix brittle test patterns (exact ordering, global state assumptions)
- Consolidate any remaining scattered duplicates across apply/* modules

### Scope - non-goals

- Adding new coverage (that's T022)
- Refactoring test infrastructure (T019/T020 handle that)
- Touching tests outside apply/* unless clearly redundant

## Background

### Relevant documents

- `doc/issues/test_setup.md` - Audit section (line 270+)

### Key files

- `src/domain/apply.zig` - parent module with legacy tests
- `src/domain/apply/validation.zig` - has own tests now
- `src/domain/apply/targeting.zig` - has own tests now
- `src/domain/apply/effects/*.zig` - effect modules

### Existing systems, memories, research, design intent

From audit:
> Redundant coverage: Unit tests sprinkled across apply.zig, apply/validation.zig, and apply/targeting.zig duplicate the same predicate/targeting scenarios after the file split. We can consolidate them into the new module-specific tests and delete the legacy ones in apply.zig.

## Changes Required

1. Audit tests in `apply.zig` - identify which are duplicated in submodules
2. Delete duplicates, keeping the version in the most appropriate location
3. Review remaining tests for brittleness (exact event ordering, manual setup)
4. Refactor brittle tests to assert on invariants rather than implementation details

### Challenges / Tradeoffs / Open Questions

- Some "duplicates" may test slightly different scenarios - need careful comparison
- Brittle tests may be catching real bugs via their specificity - balance needed

## Tasks / Sequence of Work

1. [x] List all tests in `apply.zig` with their counterparts in submodules
2. [x] Delete confirmed duplicates
3. [x] Identify brittle patterns in remaining tests
4. [x] Refactor or document acceptable brittleness
5. [x] Run full test suite, verify no regressions

## Test / Verification Strategy

### success criteria / ACs

- No duplicate test names across apply.zig and its submodules
- `just check` passes
- Test count may decrease (duplicates removed) but coverage unchanged

## Progress Log / Notes

- 2026-01-08: Task created from audit in doc/issues/test_setup.md

### 2026-01-08: Consolidation Complete

**Findings:**
- apply.zig had 15 tests that should live in submodules
- targeting.zig had 10 stub tests (all `return error.SkipZigTest`)
- validation.zig had 11 working tests

**Changes:**
1. Moved 4 `rulePredicatesSatisfied` tests from apply.zig â†’ validation.zig
2. Replaced 7 stubs in targeting.zig with real implementations from apply.zig:
   - 3 expressionAppliesToTarget tests
   - 2 getModifierTargetPredicate tests
   - 2 canModifierAttachToPlay tests
3. Deleted 4 duplicate tests from apply.zig (already in validation.zig):
   - compareF32 operators
   - compareReach operators
   - canWithdrawPlay x2

**Final test counts:**
- apply.zig: 0 (was 15 - all moved/deleted)
- targeting.zig: 8 (was 10 stubs, now 8 real)
- validation.zig: 15 (was 11, added 4)

No brittleness issues found - tests assert on behaviour, not implementation.

`just check` passes.
