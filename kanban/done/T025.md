# T025: Extend Target Validity to Include Expression Filters
Created: 2026-01-08

## Problem statement

Cards with expression filters (e.g., Riposte requiring `control >= 0.6`) don't show the orange "no valid targets" warning. They appear playable even when no target satisfies the filter.

Related: `hasAnyTargetInRange` doesn't skip incapacitated targets, which is misleading.

## Background

T009 introduced the warning system for attacks out of range. The same feedback should apply to:
- Advantage threshold filters (control, pressure, position)
- Any other expression-level predicates

### Key files

- `src/domain/apply/targeting.zig` - `hasAnyTargetInRange()`
- `src/domain/query/combat_snapshot.zig` - `validateCards()` calls it
- `src/domain/apply/validation.zig` - `evaluatePredicate()` handles filters
- `src/domain/cards.zig` - `Template.getTechniqueWithExpression()`

### Existing systems

- `expressionAppliesToTarget()` already evaluates filters with engagement context
- `Agent.isIncapacitated()` checks if target can't act

## Changes Required

1. **Rename** `hasAnyTargetInRange` → `hasAnyValidTarget` (scope expanded)
2. **Change signature**: take `Instance` instead of `Template` (needed for `PredicateContext`)
3. **Skip incapacitated targets** in the enemy loop
4. **Check expression filters** via `expressionAppliesToTarget()` for technique expressions
5. **Update call sites** in `combat_snapshot.zig`

### Flow

```
For each enemy:
  - Skip if incapacitated
  - Skip if weapon reach < engagement range
  - Skip if expression filter fails (advantage threshold, etc.)
  - If any enemy passes all checks → true
Return false
```

## Tasks

1. [x] Rename and update signature in `targeting.zig`
2. [x] Add incapacitated check
3. [x] Add expression filter check using `expressionAppliesToTarget`
4. [x] Update call sites in `validateCards()`
5. [x] Integration test: riposte shows warning when control < 0.6

## Test Strategy

### Integration tests (range_validation.zig)

- `Riposte shows warning when control below threshold`
- `Riposte shows no warning when control meets threshold`

## Progress Log

- 2026-01-08: Implementation complete

### Implementation Summary

**Design decision:** Unified `hasAnyValidTarget` to check all expressions (not just technique), with:
- Incapacitation check (single location)
- Weapon reach check (for technique effects only)
- Expression filter check via `expressionAppliesToTarget()`
- Short-circuit for `.self` targets (always valid, avoids stack pointer bug in `getTargetsForQuery`)

**Files modified:**
- `src/domain/apply/targeting.zig`:
  - Renamed `hasAnyTargetInRange` → `hasAnyValidTarget`
  - Changed signature to take `Instance` + `World` (not `Template` + `Encounter`)
  - Added `isValidTargetForExpression()` helper
  - Deleted redundant `cardHasValidTargets()`
- `src/domain/query/combat_snapshot.zig`: Updated call sites
- `src/testing/integration/harness.zig`: Added `setControl()` helper
- `src/testing/integration/domain/range_validation.zig`: Added riposte threshold tests
