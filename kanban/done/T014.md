# T014: Dud Cards Foundation
Created: 2026-01-08

## Problem statement / value driver

Card system needs to support blocking and forced-play mechanics for condition-injected dud cards. Must use existing Rule/Effect pipeline, not bespoke fields.

### Scope - goals

- Extend Trigger union with new cases (preserve union structure)
- Extend TagSet with precision/finesse/involuntary tags
- Add Effect.cancel_play for blocking
- Hand management respects on_play_attempt rules

### Scope - non-goals

- Actual dud card definitions (T015)
- Condition→card injection wiring (T015)

## Background

### Relevant documents

- `doc/trauma_wounds_conditions_ph2.md` (Phase 4.5)
- Architectural Alignment Review section
- `cards_data_model_overview` memory

### Key files

- `src/domain/cards.zig` (Trigger, TagSet, Effect, Rule)
- Hand validation code (TBD)

### Existing systems

- `Trigger` is a union(enum) with payloads - must preserve this
- `TagSet` is a packed bitset with hasTag/hasAnyTag
- Rules couple Trigger + Predicate + Expression
- Effects are a union with payloads for mutations

## Changes Required

### 1. Extend Trigger union (`cards.zig`)

**IMPORTANT**: Keep as union(enum), don't collapse to plain enum.

```zig
pub const Trigger = union(enum) {
    on_play,
    on_draw,
    on_tick,
    on_event: EventTag,
    on_commit,
    on_resolve,
    while_in_hand,     // NEW: continuous effect while in hand
    on_play_attempt,   // NEW: fires when any card play is attempted
};
```

### 2. Extend TagSet (`cards.zig`)

```zig
pub const TagSet = packed struct {
    // ... existing tags ...
    precision: bool = false,   // fine motor techniques (blocked by tremor)
    finesse: bool = false,     // dexterous techniques
    involuntary: bool = false, // status/dud cards
    // Update bit width if needed
};
```

### 3. Add Effect.cancel_play (`cards.zig`)

```zig
pub const Effect = union(enum) {
    // ... existing effects ...
    cancel_play,  // prevents the triggering play from resolving
};
```

### 4. Add Predicate for tag matching

Check if existing `Predicate.has_tag` works, or add:

```zig
card_has_tag: TagSet,  // check if attempted card has these tags
```

### 5. Hand validation checks on_play_attempt rules

When a card play is attempted:
1. Iterate all cards in hand
2. For each card, check rules with `trigger = .on_play_attempt`
3. If rule fires and effect is `.cancel_play`, block the play

## Test / Verification Strategy

### success criteria / ACs

- [x] Trigger remains a union(enum)
- [x] TagSet includes precision/finesse/involuntary
- [x] Effect.cancel_play exists
- [x] Card with on_play_attempt + cancel_play blocks matching plays
- [x] Build passes, tests pass, lint clean

### unit tests

- Test Trigger union usage
- Test TagSet.hasTag with new tags
- Test on_play_attempt rule evaluation
- Test cancel_play effect blocking

## Challenges / Tradeoffs / Open Questions

- **on_play_attempt scope**: Does it fire for all cards or just cards with matching predicates?
  - Answer: Predicate filters which plays trigger the rule

- **cancel_play feedback**: How does UI know play was blocked?
  - Consider: return blocked reason from validation

## Progress Log / Notes

Architectural requirement: extend existing unions, don't replace with plain enums or add bespoke fields. Model blocking as Rule → Effect, not as card field.

### 2026-01-08 Implementation

**Changes made:**

1. **Trigger union** (`src/domain/cards.zig:70-80`)
   - Added `.while_in_hand` - continuous effect while card is in hand
   - Added `.on_play_attempt` - fires when any card play is attempted

2. **TagSet** (`src/domain/cards.zig:82-125`)
   - Added `precision: bool` - fine motor techniques (blocked by tremor)
   - Added `finesse: bool` - dexterous techniques
   - Added `involuntary: bool` - status/dud cards
   - Updated bitcast width from u15 to u18

3. **Effect.cancel_play** - Already existed, no changes needed

4. **Predicate approach** - Reused existing `has_tag` predicate
   - Added `cardTemplateMatchesPredicate()` helper for evaluating predicates against attempted card's template
   - Supports: `.always`, `.has_tag`, `.not`, `.all`, `.any`

5. **Blocking validation** (`src/domain/apply/validation.zig:200-258`)
   - Added `ValidationError.BlockedByDudCard`
   - Added `checkOnPlayAttemptBlockers()` - iterates hand cards, finds rules with `.on_play_attempt` trigger, evaluates predicates, returns blocking card ID if `.cancel_play` effect
   - Integrated into `canPlayerPlayCard()` - check runs before other validation

6. **Exports** - Added to `apply/mod.zig` and `apply.zig`:
   - `checkOnPlayAttemptBlockers`
   - `cardTemplateMatchesPredicate`

**Tests added:**
- `TagSet.hasTag with dud card tags`
- `TagSet.hasAnyTag with dud card tags`
- `Trigger union includes dud card triggers`
- `cardTemplateMatchesPredicate with always/has_tag/not/all/any predicates`
- Skipped integration tests (need fixtures): `checkOnPlayAttemptBlockers`

**Design decision:** `has_tag` predicate reused rather than adding new `card_has_tag` variant. The `cardTemplateMatchesPredicate` function evaluates predicates in the context of the attempted card, similar to existing `playMatchesPredicate` pattern.
