# T023: Species Foundation
Created: 2026-01-08

## Problem statement / value driver

Agents lack a species concept. Natural weapons (fists, claws, bite), base resource values, and creature categorisation have no natural home. See `doc/artefacts/species_design.md`.

### Scope - goals

- Introduce `Species` struct with body plan, natural weapons, base resources, tags
- Add `NaturalWeapon` struct (template + required body part)
- Add `Tag` enum and `TagSet` for creature categorisation
- Add `Agent.species` field
- Define initial species: Dwarf, Goblin (minimal, for testing)

### Scope - non-goals

- Armament integration (T024)
- Stat generation factory (future work)
- Full species catalogue
- Body plan variants (size, etc.)

## Background

### Relevant documents

- `doc/artefacts/species_design.md` - full design
- `doc/issues/species.md` - original problem statement

### Key files

- `src/domain/species.zig` (new)
- `src/domain/combat/agent.zig` - add species field
- `src/domain/body.zig` - PartTag, PartDef
- `src/domain/weapon.zig` - Template

### Existing systems, memories, research, design intent

- Body system uses data-driven PartDef plans (HumanoidPlan)
- Weapons use Template struct
- Agent already has Name tagged union pattern (static/dynamic)

## Changes Required

### 1. Create `src/domain/species.zig`

```zig
pub const Tag = enum {
    humanoid, quadruped,
    mammal, reptile, insectoid,
    predator, pack_hunter,
    undead, construct, demon,
};

pub const TagSet = std.EnumSet(Tag);

pub const NaturalWeapon = struct {
    template: *const weapon.Template,
    required_part: body.PartTag,
};

pub const Species = struct {
    name: []const u8,
    body_plan: []const body.PartDef,
    natural_weapons: []const NaturalWeapon,
    base_blood: f32,
    base_stamina: f32,
    base_focus: f32,
    tags: TagSet,
};
```

### 2. Define natural weapon templates

Fist, bite, headbutt - minimal templates in `src/data/` or inline.

### 3. Define initial species

```zig
pub const DWARF: Species = .{
    .name = "Dwarf",
    .body_plan = &body.HumanoidPlan,
    .natural_weapons = &.{
        .{ .template = &FIST, .required_part = .hand },
        .{ .template = &HEADBUTT, .required_part = .head },
    },
    .base_blood = 4.5,
    .base_stamina = 12.0,
    .base_focus = 8.0,
    .tags = TagSet.initMany(&.{ .humanoid, .mammal }),
};
```

### 4. Add `Agent.species`

```zig
species: *const Species = &species.DWARF,  // default for migration
```

### Challenges / Tradeoffs / Open Questions

- Natural weapon Templates need defining - keep minimal for now
- Where to put species definitions? `src/data/species.zig` or `src/domain/species.zig`?
- Default species for existing tests - use DWARF as fallback

## Tasks / Sequence of Work

1. [x] Create `src/domain/species.zig` with Tag, TagSet, NaturalWeapon, Species
2. [x] Create natural weapon templates (fist, bite, headbutt)
3. [x] Define DWARF and GOBLIN species
4. [x] Add `Agent.species` field with default
5. [x] Wire into domain module exports
6. [x] Unit tests for species types
7. [x] Verify existing tests pass (migration)

## Test / Verification Strategy

### success criteria / ACs

- Species struct compiles and is usable
- Agent has species field
- Existing tests pass unchanged (default species)
- `just check` passes

### unit tests

- TagSet operations (init, contains, union)
- Species field access
- NaturalWeapon required_part linkage

## Quality Concerns / Risks / Potential Future Improvements

- Natural weapon templates are placeholders - refine when combat uses them (T024)
- Base resources are fixed values - future stat generation will replace
- Tag set may grow - keep extensible

## Progress Log / Notes

- 2026-01-08: Task created from species_design.md

### 2026-01-08: Implementation Complete

**Files created/modified:**
- `src/domain/species.zig` (new) - Tag enum, TagSet, NaturalWeapon, Species structs
- `src/domain/weapon.zig` - added `.unarmed` category
- `src/domain/combat/agent.zig` - added `species` field with default `&DWARF`
- `src/domain/mod.zig` - export species module
- `src/main.zig` - added species.zig to test discovery

**Natural weapon templates defined:**
- FIST (swing, clinch reach, bludgeon)
- BITE (thrust, clinch reach, pierce+slash)
- HEADBUTT (thrust, clinch reach, bludgeon)

**Species defined:**
- DWARF: HumanoidPlan, fist+headbutt, blood 4.5, stamina 12, focus 8, tags: humanoid+mammal
- GOBLIN: HumanoidPlan, fist+bite, blood 3.5, stamina 8, focus 6, tags: humanoid+mammal

**Tests:**
- 5 new unit tests in species.zig (TagSet ops, Species fields, NaturalWeapon links)
- All 444 tests pass (222 unit + 222 integration)

Ready for T024 (Armament integration).
