# T017: Condition Display in Combat UI
Created: 2026-01-08

## Problem statement / value driver

Conditions (pain, trauma, blood loss, adrenaline, etc.) need visible representation in the combat UI for both player and opponents. Currently conditions are computed but not displayed.

### Scope - goals

- Player's active conditions visible
- Opponent conditions visible (at least major ones)
- Visual distinction between condition severities
- Adrenaline state visible (surge vs crash)

### Scope - non-goals

- Combat log messages (see T016)
- Detailed penalty breakdowns (maybe tooltip later)

## Background

### Relevant documents

- `doc/trauma_wounds_conditions_ph2.md` (Addendum: Revised Increment 4)
- `doc/presentation-domain-decoupling.md` (future: DTO approach)

### Key files

- `src/presentation/views/chrome.zig` - Player status bars (stamina, focus, blood)
- `src/presentation/views/combat/view.zig` - Main combat view, enemy hover tooltip (empty)
- `src/presentation/views/combat/avatar.zig` - Player/enemy avatar sprites
- `src/domain/query/combat_snapshot.zig` - DTO layer (conditions not yet exposed)

### Existing systems

- Chrome renders player resource bars (stamina, focus, blood) - no conditions
- Combat view has enemy hover rect (currently empty) - good place for detailed view
- Avatar is just sprite rendering - conditions could appear nearby
- `Agent.activeConditions()` iterator yields all conditions (stored + computed)
- `ConditionIterator` respects suppression (e.g., adrenaline surge suppresses pain conditions)

## Design Decisions

### Display locations

1. **Compact view (always visible)**:
   - Player: below resource bars in chrome, or next to avatar
   - Enemies: below avatar sprite (small icons/text)

2. **Expanded view (on hover)**:
   - Enemy hover tooltip: list conditions with severity colors
   - Player: possibly a dedicated status panel

### Condition grouping

Show **worst active condition per category** (avoid clutter):

| Category | Conditions (worst→least) | Color |
|----------|-------------------------|-------|
| Blood | hypovolemic_shock → bleeding_out → lightheaded | Red |
| Pain | agonized → suffering → distracted | Orange |
| Trauma | reeling → trembling → unsteady → dazed | Yellow |
| Adrenaline | adrenaline_surge (green), adrenaline_crash (purple) | Special |
| Engagement | pressured, weapon_bound, unbalanced | Blue |
| Sensory | blinded, deafened | Grey |
| Critical | incapacitated | Red/flashing |

### Visual style options

**Option A: Text chips** (simpler)
- Colored text labels: `[AGONIZED]` `[REELING]`
- Pro: Clear, no art needed
- Con: Takes space

**Option B: Icons** (future)
- Small colored icons with tooltip
- Pro: Compact
- Con: Needs icon assets

**Recommendation**: Start with text chips, leave room for icons later.

## Architecture Note

**Current approach**: Direct domain access (`Agent.activeConditions()`)

**Future approach** (per `doc/presentation-domain-decoupling.md`):
- Add `conditions: []ConditionDTO` to `PlayerStatus` / `EnemyStatus` in CombatSnapshot
- View consumes DTOs only
- Can defer to Stage 1 of decoupling roadmap

For T017, acceptable to use direct access for now, refactor later.

## Changes Required

### 1. Condition display helper

```zig
// src/presentation/views/combat/conditions.zig (new)
pub const ConditionDisplay = struct {
    condition: damage.Condition,
    label: []const u8,
    color: Color,
};

pub fn getDisplayConditions(agent: *const Agent, engagement: ?*const Engagement) []ConditionDisplay {
    // Iterate conditions, pick worst per category, return display list
}
```

### 2. Player conditions in chrome

Extend `StatusBars` or add new component below resource bars.

### 3. Enemy conditions on avatar

Below enemy sprite, show 1-3 condition chips.

### 4. Enemy hover tooltip

Populate the empty hover rect in `view.zig` with condition list.

## Tasks / Sequence of Work

- [x] Create `conditions.zig` helper (iterate, group, pick worst)
- [x] Add condition text rendering to enemy hover tooltip
- [x] Add compact condition display below enemy avatars
- [x] Add player conditions to chrome (below resource bars)
- [x] Color scheme for severity/category
- [x] Incapacitated X overlay on enemy sprites
- [ ] Test with multiple conditions active (visual playtest)

## Test / Verification Strategy

### success criteria / ACs

- [x] Can visually identify when player is `.distracted`, `.trembling`, etc.
- [x] Can see opponent's major conditions
- [x] Adrenaline surge/crash visually distinct
- [x] Hover over enemy shows full condition list
- [x] Compact view shows worst condition per category

### user acceptance

Playtest: player understands their impairment state at a glance.

## Design Decisions (Resolved)

1. **Max conditions**: Up to 12, but only worst per category (should be ~6-7 max in practice)
2. **Display**: Condition names only (no numeric pain/trauma values)
3. **Incapacitated**: Big white X over sprite - they dead
4. **Rendering**: New `Renderable.condition_chip` using same TTF font as combat log

## Progress Log / Notes

Stub card. Flesh out after T012 (conditions exist) and alongside UI polish pass.

---

**2026-01-08: Fleshed out design**

- Reviewed existing UI structure (chrome, combat view, avatar)
- Identified display locations (compact + hover expanded)
- Proposed grouping by category, show worst per category
- Noted architectural direction (DTO decoupling) but acceptable to defer
- Ready for implementation

---

**2026-01-08: Implementation in progress**

### Completed

1. **`src/presentation/views/combat/conditions.zig`** (NEW FILE)
   - `Category` enum: blood, pain, trauma, adrenaline, engagement, sensory, status, critical
   - `ConditionDisplay` struct: condition, category, label, color, priority
   - `category_colors`: color scheme per category
   - `conditionName()`: uppercase labels for display (e.g., "AGONIZED", "BLEEDING")
   - `categoryFor()`, `priorityFor()`, `colorFor()`: condition metadata
   - `ConditionBuffer`: fixed array + len (BoundedArray removed in Zig 0.15)
   - `getDisplayConditions(agent, engagement)`: returns worst condition per category, sorted by priority
   - `isIncapacitated(agent)`: helper for special rendering
   - Tests for category/priority ordering

2. **`src/presentation/views/combat/view.zig`**
   - Added `conditions_mod` import
   - Enemy hover tooltip now shows conditions:
     - Finds agent by ID from `opposition.enemies`
     - Gets engagement via `encounter.getPlayerEngagementConst()`
     - Calls `conditions_mod.getDisplayConditions()`
     - Renders colored text labels with `.small` font

### Remaining

- [x] Visual playtest with multiple conditions active

### Key Implementation Notes

- No new `Renderable` variant needed - existing `Text` with `.small` font and color works
- `getDisplayConditions` takes `?Engagement` (value) but converts internally to pointer for `activeConditions()`
- Colors match combat log scheme (red=blood, orange=pain, yellow=trauma, green=surge, purple=crash)
- Zig 0.15: `BoundedArray` removed, use manual struct with fixed array + len

---

**2026-01-08: Implementation complete**

### Completed

3. **`src/presentation/views/combat/avatar.zig`**
   - Import `conditions_mod`
   - `appendIncapacitatedOverlay()`: dark overlay + white "X" centered on sprite
   - `appendConditions()`: renders up to 3 worst conditions (per category) below engagement bars
   - Called from `appendRenderables()` for each enemy

4. **`src/presentation/views/chrome.zig`**
   - Import `conditions_mod`
   - `StatusBars` now stores player agent pointer
   - `renderConditions()`: renders player conditions horizontally below blood bar
   - Special "!! INCAPACITATED !!" warning if player is incapacitated

### Implementation Details

- Enemy conditions: positioned below engagement bars + range label (bar_start_y + 31), max 3 shown
- Player conditions: positioned below blood bar, rendered horizontally with spacing
- Incapacitated overlay: semi-transparent black rect + white "X" character
- Font: `.small` (14pt) for all condition text
- Build and tests pass, formatting verified
