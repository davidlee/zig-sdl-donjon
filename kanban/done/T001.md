# T001: Channel Foundation

**Status**: done
**Phase**: 1 of 6 (Timing/Simultaneity/Positioning)
**Design Doc**: `doc/timing_simultaneity_positioning.md`

## Goal

Establish channel system to prevent invalid simultaneous plays. Foundation for timeline-based combat.

## Tasks

- [x] 1.1 Add `ChannelSet` type to `cards.zig`
- [x] 1.2 Add `channels` field to `Technique` struct
- [x] 1.3 Populate channels for existing techniques
- [x] 1.4 Add `wouldConflictOnChannel` to `TurnState`
- [x] 1.5 Add channel validation to play commands

## Acceptance Criteria

- [x] Playing two weapon techniques in same turn is rejected
- [x] `ChannelSet.conflicts()` is symmetric
- [x] Existing tests pass (techniques default to weapon channel)

## Implementation Summary

### Changes Made

1. **`src/domain/cards.zig`**:
   - Added `ChannelSet` packed struct with `weapon`, `off_hand`, `footwork`, `concentration` flags
   - Added `conflicts()`, `isEmpty()`, `merge()` methods
   - Added `channels: ChannelSet = .{ .weapon = true }` field to `Technique` struct
   - Added unit tests for ChannelSet

2. **`src/domain/card_list.zig`**:
   - Updated `block` technique to use `.channels = .{ .off_hand = true }` (shield technique)
   - All other techniques default to `.weapon = true`

3. **`src/domain/combat.zig`**:
   - Added `TurnState.wouldConflictOnChannel()` method
   - Added `getPlayChannels()` helper function
   - Added unit tests for channel conflict detection

4. **`src/domain/apply.zig`**:
   - Added `ChannelConflict` to `ValidationError`
   - Added `wouldConflictWithInPlay()` and `getCardChannels()` helper functions
   - Added channel validation to `playActionCard()` (selection phase)
   - Added channel validation to `commitAdd()` (commit phase)

### Tests Added

- `ChannelSet.conflicts detects overlap`
- `ChannelSet.conflicts is symmetric`
- `ChannelSet.merge combines flags`
- `empty ChannelSet has no conflicts`
- `ChannelSet.isEmpty`
- `TurnState.wouldConflictOnChannel detects weapon channel conflict`
- `TurnState.wouldConflictOnChannel allows different channels`
- `TurnState.wouldConflictOnChannel empty state has no conflicts`

## Key Files

```
src/domain/cards.zig      # ChannelSet, Technique.channels
src/domain/combat.zig     # TurnState.wouldConflictOnChannel
src/domain/apply.zig      # validation in play commands
src/domain/card_list.zig  # technique channel assignments
```

## Notes

- Conservative validation: reject if *any* existing play uses same channel
- Full time-aware validation comes in Phase 2 (Timeline)
- Techniques are in `src/domain/card_list.zig`, not `src/content/` (which is empty)
- `Exclusivity` enum retained for now; `ChannelSet` is the new system

## Unlocks

- Phase 2: Timeline Structure (time-aware channel checking)
- Footwork techniques can coexist with weapon techniques

---

**Created**: 2026-01-06
**Completed**: 2026-01-06
**Design session**: timing/simultaneity/positioning
