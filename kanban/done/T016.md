# T016: Trauma System Events & Combat Log
Created: 2026-01-08

## Problem statement / value driver

Pain, trauma, adrenaline, and condition changes need to be communicated to the player via the combat log. Without events, these systems are invisible.

### Scope - goals

- Events emitted for pain/trauma accumulation
- Events for condition gain/loss (especially computed conditions)
- Events for adrenaline surge/crash transitions
- Events for incapacitation
- Combat log renders these meaningfully

### Scope - non-goals

- UI display of conditions (see T017)
- Dud card injection feedback (handled by card system)

## Background

### Relevant documents

- `doc/trauma_wounds_conditions_ph2.md` (Addendum: Revised Increment 4)

### Key files

- `src/domain/events.zig` - Event definitions (condition_applied/expired already existed)
- `src/domain/resolution/outcome.zig` - Pain/trauma infliction & adrenaline trigger
- `src/domain/combat/agent.zig` - invalidateConditionCache() emits condition events
- `src/presentation/combat_log.zig` - Already formats condition events

### Existing systems

Existing event types for wounds, blood loss. Follow same patterns.

## Changes Required

**Key insight**: Existing `condition_applied`/`condition_expired` events already defined and formatted by combat log. The gap was that computed conditions (pain/trauma thresholds) weren't emitting these events.

### Actual changes needed:
1. Call `invalidateConditionCache()` after pain/trauma infliction to emit events for threshold crossings
2. Emit `condition_applied` when adrenaline_surge is added directly

### NOT needed (existing events suffice):
- `pain_increased`, `trauma_increased` - conditions emit via threshold system
- `condition_gained`, `condition_lost` - already exist as `condition_applied`, `condition_expired`
- `adrenaline_surge_triggered`, `adrenaline_crash_triggered` - handled by condition_applied/expired
- `agent_incapacitated` - incapacitated is a condition, so condition_applied covers it

## Tasks / Sequence of Work

- [x] Identify event emission points in T010-T013 code
- [x] Define event types (existing events sufficient)
- [x] Wire emission
- [x] Combat log formatting (already done in T010-T013)

## Test / Verification Strategy

### success criteria / ACs

- [x] Player can see in combat log when they or opponents gain conditions
- [x] Adrenaline surge/crash is narrated (via condition_applied/expired)
- [x] Incapacitation is clearly communicated (via condition_applied for .incapacitated)

## Progress Log / Notes

Stub card. Flesh out after core trauma implementation (T010-T013).

---

**2026-01-08: Implementation Complete**

### Analysis

Audited existing event emission and found:
- `condition_applied`/`condition_expired` events already defined and formatted by combat log
- Dud card injection (T015) already uses `condition_applied` events
- `Agent.invalidateConditionCache()` correctly emits events for computed conditions via `emitConditionDiff()`
- **Gap**: `invalidateConditionCache()` was only called in tests, never in production code

### Changes Made

1. **`src/domain/resolution/outcome.zig`**:
   - Added `events` import
   - After pain/trauma infliction: call `attack.defender.invalidateConditionCache(&w.events, is_defender_player)`
   - After adrenaline surge addition: emit `condition_applied` event directly
   - Added test: `resolveTechniqueVsDefense emits condition_applied for pain threshold`

2. **`src/domain/combat/agent.zig`**:
   - Made `isPlayer()` public (was private helper)

### Tests Added

- `resolveTechniqueVsDefense emits condition_applied for pain threshold`: Verifies condition events are emitted when pain crosses threshold during combat resolution

### Build & Test

- All tests pass
- Linted clean
