# T015: Dud Card Definitions & Injection
Created: 2026-01-08

## Problem statement / value driver

Conditions should inject dud cards into hand. Injection must be declarative via event system, not imperative if-chains.

### Scope - goals

- Define dud cards (Wince, Retch, Stagger, Tremor, Blackout)
- Condition gain emits event
- Dud cards subscribe via Trigger.on_event
- Cards exhaust on play

### Scope - non-goals

- Card system extensions (T014)

## Background

### Relevant documents

- `doc/trauma_wounds_conditions_ph2.md` (Phase 4.6)
- Architectural Alignment Review section
- `cards_data_model_overview` memory

### Key files

- `src/domain/events.zig` (EventTag)
- `src/domain/cards.zig` (Template, Rule)
- Card definitions file (TBD - possibly new file for status cards)
- Condition application path (where conditions are added)

### Existing systems

- Cards subscribe to events via `Trigger.on_event: EventTag`
- `Effect.move_card` moves cards between zones
- `Effect.exhaust_card` removes card from game
- Pattern: declarative rules, not imperative injection

## Changes Required

### 1. Add condition_gained event (`events.zig`)

```zig
pub const EventTag = enum {
    // ... existing events ...
    condition_gained,
};

// Event payload structure
pub const Event = union(EventTag) {
    // ... existing ...
    condition_gained: struct {
        agent_id: entity.ID,
        condition: damage.Condition,
    },
};
```

### 2. Emit event when condition gained

In Agent.addCondition (or wherever conditions are applied):

```zig
pub fn addCondition(self: *Agent, event_sys: *EventSystem, condition: Condition, expiration: Expiration) !void {
    try self.conditions.append(self.alloc, .{ .condition = condition, .expiration = expiration });
    try event_sys.push(.{ .condition_gained = .{
        .agent_id = self.id,
        .condition = condition,
    } });
}
```

### 3. Add Predicate for condition matching

```zig
// Predicate to match condition_gained events
event_condition: Condition,  // matches if event is condition_gained with this condition
```

### 4. Define dud cards

```zig
pub const wince = Template{
    .id = .wince,
    .kind = .status,
    .tags = .{ .involuntary = true },
    .rules = &.{
        Rule{
            .trigger = .{ .on_event = .condition_gained },
            .predicate = .{ .event_condition = .distracted },
            .expressions = &.{.{
                .effect = .{ .move_card = .{ .from = .limbo, .to = .hand } },
                .target = .self,
            }},
        },
        Rule{
            .trigger = .on_play,
            .predicate = .always,
            .expressions = &.{.{ .effect = .exhaust_card }},
        },
    },
};

pub const tremor = Template{
    .id = .tremor,
    .kind = .status,
    .tags = .{ .involuntary = true },
    .rules = &.{
        Rule{
            .trigger = .{ .on_event = .condition_gained },
            .predicate = .{ .event_condition = .trembling },
            .expressions = &.{.{
                .effect = .{ .move_card = .{ .from = .limbo, .to = .hand } },
                .target = .self,
            }},
        },
        Rule{
            .trigger = .on_play_attempt,
            .predicate = .{ .card_has_tag = .{ .precision = true } },
            .expressions = &.{.{ .effect = .cancel_play }},
        },
        Rule{
            .trigger = .on_play,
            .predicate = .always,
            .expressions = &.{.{ .effect = .exhaust_card }},
        },
    },
};

// Similar for: retch (.suffering), stagger (.unsteady), blackout (.reeling)
```

### 5. Card zone for dud cards

Dud cards need to exist somewhere before injection. Options:
- **Limbo zone**: Cards exist in limbo, move to hand on event
- **Create on demand**: Effect.create_card variant

Prefer limbo zone for consistency with existing card movement.

## Test / Verification Strategy

### success criteria / ACs

- [ ] condition_gained event emitted when condition added
- [ ] Wince injected when .distracted gained
- [ ] Tremor blocks .precision cards while in hand
- [ ] Playing dud exhausts it
- [ ] Build passes, tests pass, lint clean

### unit tests

- Test event emission on condition gain
- Test dud card injection via event subscription
- Test blocking behavior
- Test exhaust on play

## Challenges / Tradeoffs / Open Questions

- **Where do dud cards live before injection?**
  - Answer: Limbo zone, moved to hand on event

- **Which agent's hand?**
  - The agent who gained the condition (event payload includes agent_id)

- **Multiple condition gains = multiple duds?**
  - Yes, each gain triggers injection (per earlier design decision)

## Progress Log / Notes

Architectural requirement: injection via event subscription in card rules, not imperative code in addCondition. This keeps "conditions inject dud cards" declarative.
