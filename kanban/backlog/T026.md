# T024: Natural Weapons in Armament
Created: 2026-01-08

## Problem statement / value driver

With Species defined (T023), natural weapons need to integrate into combat. They should be available alongside equipped weapons, but gated by body part integrity (no hand = no punch).

### Scope - goals

- Add `.natural` slots to Armament
- Populate natural slots from Agent.species at init/combat start
- Gate availability on body part state
- Expose unified weapon iteration for combat resolution

### Scope - non-goals

- New combat mechanics using natural weapons
- AI weapon selection logic changes
- Natural weapon damage tuning

## Background

### Relevant documents

- `doc/artefacts/species_design.md` - Armament integration section

### Key files

- `src/domain/combat/armament.zig` - Armament struct
- `src/domain/combat/agent.zig` - Agent.weapons, Agent.body
- `src/domain/body.zig` - Part, PartTag, severity
- `src/domain/species.zig` (T023)

### Existing systems, memories, research, design intent

From design doc:
> Natural weapons merge into Armament with `.natural` slots, populated from species at agent init. Keeps combat resolution unified.
> Natural weapons are gated by body state: no jaw = no bite, no hand = no punch.

## Changes Required

### 1. Extend Armament

```zig
pub const Armament = struct {
    // existing equipped weapon slots...

    natural: []const NaturalWeapon,  // from species, immutable
    agent: *const Agent,  // back-reference for body checks

    pub fn availableNaturalWeapons(self: *const Armament) NaturalWeaponIterator {
        // yields only those whose required_part is functional
    }

    pub fn allAvailableWeapons(self: *const Armament) WeaponIterator {
        // unified iteration: equipped + available natural
    }
};
```

### 2. Body part availability check

```zig
fn isPartFunctional(body: *const Body, tag: PartTag) bool {
    // find part by tag, check severity != .missing/.destroyed
    // may need to check multiple parts (both hands for .hand tag)
}
```

### 3. Populate at agent init

When Agent initializes or enters combat, copy species.natural_weapons reference to Armament.

### 4. Agent derives body from species

Currently Agent.init takes `body: Body` as argument. This is clunky and error-prone. Agent should derive body from its species:

```zig
// Before: body passed in
pub fn init(alloc, slot_map, dr, ds, sb, bd, ...) // bd = body

// After: body derived from species
pub fn init(alloc, slot_map, dr, ds, sb, species, ...) {
    const bd = try body.Body.fromPlan(alloc, species.body_plan);
    // ...
}
```

This requires updating all Agent.init call sites (World.init, fixtures, tests).

### 5. Armament convenience for equipped weapons

Add method to create new Armament with different equipped weapons:

```zig
pub fn withEquipped(self: Armament, equipped: EquippedSlots) Armament {
    return .{
        .natural = self.natural,  // preserve natural
        .equipped = equipped,     // replace equipped
    };
}
```

Allows cleanly separating natural (from species) and equipped (from gear) weapons.

### Challenges / Tradeoffs / Open Questions

- **Part tag to part lookup**: PartTag (.hand) may map to multiple parts (left_hand, right_hand). Need "any functional" or "specific side"?
- **Armament back-reference**: Armament needs Agent/Body access for availability checks. Adds coupling.
- **When to populate**: At Agent.init() or at combat start? Probably init - natural weapons are always available conceptually.
- **Call site updates**: Agent body refactor touches World.init, fixtures.agentFromTemplate, player.newPlayer, AgentTemplate (personas). Do as first step to minimize churn.

### Decisions

- Use "any functional" for symmetric parts - if either hand works, can punch
- Back-reference acceptable - Armament already coupled to Agent via weapon slots

## Tasks / Sequence of Work

1. [ ] **Refactor Agent to derive body from species** (do first - reduces churn)
   - Update Agent.init signature: species instead of body
   - Update World.init, fixtures.agentFromTemplate, player.newPlayer
   - Update AgentTemplate to use species reference instead of body_plan
2. [ ] Add body part functional check (`body.isPartTagFunctional(tag)`)
3. [ ] Restructure Armament: separate natural vs equipped slots
4. [ ] Add `Armament.withEquipped()` convenience
5. [ ] Implement `availableNaturalWeapons()` with body gating
6. [ ] Implement `allAvailableWeapons()` unified iterator
7. [ ] Populate natural weapons from species in Agent init
8. [ ] Unit tests for body gating
9. [ ] Integration test: combat with natural weapons

## Test / Verification Strategy

### success criteria / ACs

- Natural weapons appear in available weapons when body parts functional
- Natural weapons disappear when required part destroyed
- Combat resolution can iterate all weapons uniformly
- `just check` passes

### unit tests

- `isPartTagFunctional` with healthy/damaged/missing parts
- `availableNaturalWeapons` filters correctly
- `allAvailableWeapons` includes both equipped and natural

### integration tests

Use `src/testing/integration/` harness:
- Agent with species fights using natural weapons
- Destroying jaw removes bite from available weapons
- Combat snapshot reflects natural weapon availability

## Quality Concerns / Risks / Potential Future Improvements

- Performance: body checks on every weapon query? Cache if needed.
- Side-specific natural weapons (right claw vs left claw) - defer until needed
- Natural weapon damage/techniques - future cards can reference them

## Progress Log / Notes

- 2026-01-08: Task created from species_design.md
- 2026-01-08: Expanded scope - Agent should derive body from species, not take as argument. Armament needs equipped/natural separation with convenience methods.
- Depends on: T023 (Species Foundation)
